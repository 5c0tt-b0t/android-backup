#!/bin/bash
#
# Riyad Preukschas <riyad@informatik.uni-bremen.de>
#
# Backs up your Android phone's storage.
# It'll also back up your current TitaniumBackup apps for faster restoration.


# on a running Android /sdcard is symlinked to /storage/emulated/[legacy|0]
# but in TWRP it's directly mounted to /sdcard (so the other dirs aren't there)
readonly ANDROID_STORAGE="/sdcard"
readonly RSYNC_CONFIG="/data/local/tmp/rsync.conf"
readonly RSYNC_FILTER_FILE=`mktemp -t "$(basename $0)"`
readonly RSYNC_DEVICE_PORT=1873  # should be above 1024 to be able to bind to without root
readonly RSYNC_LOCAL_PORT=6010
RSYNC_BIN="rsync"

alias adb="adb -d"
adb_package_path() {
  adb shell pm path "$1" | tr -d '\r' | sed "s/^package://"
}
adb_pull_app() {
  if [[ -z "$(adb_package_path \"$1\")" ]]; then
    echo "Can't find app $1"
    return 1
  else
    rsync_pull "$(adb_package_path \"$1\")" "$2"
  fi
}
adb_rm_dir() {
  adb shell "[[ -d \"$1\" ]] && rm -r \"$1\""
}
rsync_cleanup() {
  adb forward --remove tcp:${RSYNC_LOCAL_PORT}
  adb shell rm -f "${RSYNC_CONFIG}" "${RSYNC_FILTER_FILE}"
}
rsync_pull() {
  rsync --partial --progress --archive --human-readable --prune-empty-dirs --delete --filter='H .DS_Store' --filter=". ${RSYNC_FILTER_FILE}" "rsync://localhost:6010/root/$1" "$2"
  : rc $?
}
rsync_setup() {
  # from http://blog.josefsson.org/2015/11/28/automatic-android-replicant-backup-over-usb-using-rsync/
  # and http://ptspts.blogspot.de/2015/03/how-to-use-rsync-over-adb-on-android.html
  adb shell "echo \"address = 127.0.0.1\nport = ${RSYNC_DEVICE_PORT}\n\n[root]\npath = /\nuse chroot = false\nread only = true\"" \> "${RSYNC_CONFIG}"
  touch "${RSYNC_FILTER_FILE}"
  adb shell ${RSYNC_BIN} --daemon --no-detach --config="${RSYNC_CONFIG}" &  # for debugging --log-file=/proc/self/fd/2
  adb forward tcp:${RSYNC_LOCAL_PORT} tcp:${RSYNC_DEVICE_PORT}
  sleep 2
}


# make sure we get a path to backup stuff into
if [[ -z "$1" ]]; then
  backup_dir_name="./bkp `date '+%Y-%m-%dT%H-%M'`"
  echo "You haven't specified a backup directory."
  read -p "Use '${backup_dir_name}'? [y/n] " yn
  case $yn in
    [Yy]* ) ;;  # just get through
    [Nn]* ) exit;;
    * ) exit 1;;
  esac
  readonly BACKUP_DIR="${backup_dir_name}"
else
  readonly BACKUP_DIR="$1"
fi


# make sure we don't overwrite anything by accident
if [[ -d "${BACKUP_DIR}" ]]; then
  echo "WARNING: '${BACKUP_DIR}' exists already!"
  read -p "Are you sure you want to overwrite files in there? [Yes/No] " yn
  case $yn in
    'Yes'* ) ;;  # just get through
    'No'* ) exit;;
    * ) exit 1;;
  esac
fi


mkdir -p "${BACKUP_DIR}"


rsync_setup
echo "Backing up user data ..."
echo 'P /TitaniumBackup.apk' >> "${RSYNC_FILTER_FILE}"
echo 'P /TitaniumBackupPro.apk' >> "${RSYNC_FILTER_FILE}"
echo 'H .cache/' >> "${RSYNC_FILTER_FILE}"
echo 'H .thumbs/' >> "${RSYNC_FILTER_FILE}"
echo 'H .thumbnails/' >> "${RSYNC_FILTER_FILE}"
echo 'H /Android/data/com.android.providers.media/albumthumbs/' >> "${RSYNC_FILTER_FILE}"
echo 'H /Android/data/*/cache' >> "${RSYNC_FILTER_FILE}"
echo 'H /Applidium Image Cache/' >> "${RSYNC_FILTER_FILE}"
echo 'H /CameraZOOM/.packs/' >> "${RSYNC_FILTER_FILE}"
echo 'H /CameraZOOM/.temp/' >> "${RSYNC_FILTER_FILE}"
rsync_pull "${ANDROID_STORAGE}/" "${BACKUP_DIR}/"
echo "Backing up TitaniumBackup apps ..."
adb_pull_app com.keramidas.TitaniumBackup "${BACKUP_DIR}/TitaniumBackup.apk"
adb_pull_app com.keramidas.TitaniumBackupPro "${BACKUP_DIR}/TitaniumBackupPro.apk"
rsync_cleanup
echo "... Done!"
